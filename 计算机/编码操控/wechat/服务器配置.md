https://www.likeshop.cn/doc/13/77

## 阿里云/ 腾讯云
### 服务器安全组配置
点击服务器列表【更多】【网络和安全组】【安全组配置】  
点击【配置规则】    
点击【入方向】【手动添加】，端口范围填写80、443、8888，然后授权对象选择0.0.0.0/0，保存。对外开放这些端口，后续项目运行需要。  

### 服务器root账号密码修改
如果没有设置过服务器的root密码，或忘记密码，点击这里，对密码进行修改，接下来的步骤需要用到密码。如果记得密码，请忽略。

### 远程链接服务器
点击【远程连接】，输入服务器密码，点击【确定】，连接上服务器。

### 宝塔面板安装
打开宝塔官方网站 https://www.bt.cn/bbs/thread-19376-1-1.html
复制系统安装对应命令。
``` sh
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh
```
打开阿里云连接服务器的页面（终端），粘贴复制安装宝塔的命令，回车执行。


## 域名购买&&备案
线上项目搭建，没有域名的情况下，需要购买域名，可以打开https://wanwang.aliyun.com/购买域名。

点击左上角，点击【域名】，在购买的域名，会出现在列表里，没认证之前，域名状态显示”未认证”，需要点击【未认证】，按提示操作去认证域名。认证完域名以后，点击右上角的IPC备案，按提示操作去备案域名，备案域名需要等待些时间。

### 域名解析
当我们域名认证并备案通过，我们的域名就可以使用了。我们需要将域名解析到服务器，IP地址为服务器的公网IP。

## 项目部署
运行软件安装
登录宝塔面板以后，点击菜单【软件商店】，安装nginx、php、mysql。php版本根据每个产品的要求去安装。

### 如何部署https证书
点击【SSL】-【Let’s Encrypt】，选上选项，点击【申请】即可，申请成功以后关闭窗口，我们就可以使用https访问网站。

## 使用linux系统部署②
说明
如果你非常熟悉服务器部署，可以参考以下的配置部署项目。


目录权限
在linux环境下，要给server/runtime目录和server/public/uploads目录777权限。


服务器配置文件
入口文件：
php入口文件为项目根目录下：likeshopv2/server/public/index.php

Nginx配置：
```
server {
    listen 80;
    server_name  www.likeshop.localhost;
    access_log /logs/www.likeshop.localhost_access_nginx.log;
    error_log /logs/www.likeshop.localhost_error_nginx.log;
    client_max_body_size 5M;
    location / {
        root  likeshopv2/server/public;#入口文件目录
        index  index.html index.htm index.php;
        if (!-e $request_filename)
        {
            rewrite ^/(.*)$ /index.php?s=$1 last;
            break;
        }
    }
    location ~ /.*\.php/ {
        rewrite ^(.*?/?)(.*\.php)(.*)$ /$2?s=$3 last;
        break;
    }
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /var/www/html;
    }

    location ~ \.php$ {
        fastcgi_pass   127.0.0.1:9000;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME  likeshopv2/server/public$fastcgi_script_name; #入口文件目录
        include        fastcgi_params;
    }
    location = /favicon.ico {
            log_not_found off;
            access_log off;
        }
}
```
或Apache配置
```
<IfModule mod_rewrite.c>
  Options +FollowSymlinks -Multiviews
  RewriteEngine On

  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteRule ^(.*)$ index.php/$1 [QSA,PT,L]
</IfModule>
```

## 本地部署
本地部署只适合用于开发调试。
微信登录、微信支付、支付宝支付，无法在本调试。

### docker环境下部署
#### 设置docker镜像源
打开docker软件。


复制源的配置参数。
```
{
  "experimental": true,
  "features": {
    "buildkit": true
  },
  "registry-mirrors": [
    "https://v7iz9n04.mirror.aliyuncs.com",
    "https://registry.docker-cn.com",
    "http://hub-mirror.c.163.com"
  ]
}
```

#### 启动运行
使用终端进入docker目录：cd likeshop/docker 。

运行docker-compose -p likeshop down && docker-compose -p likeshop up -d （调试时时，可去掉-d参数，-d参数是让docker后台运行），启动docker容器组，第一次运行需要下载项目依赖的镜像，速度会比较慢。过程出现网络超时，重新运行即可,一直无法下载镜像，继续更换镜像源。

出现容器启动失败时，请根据提示信息，查看端口是否被占用。默认mysql容器只支持X86架构（一般的服务器和电脑都是X86架构），如果是ARM架构，修改编辑docker-compose.yml文件，修改mysql镜像。

启动成功后，如果是本地部署，使用chrome浏览器访问：http://www.likeshop.localhost ，其他浏览器，需要配置host文件，将www.likeshop.localhost解析到127.0.0.1。如果是服务器部署，请修改docker/config/nginx/conf.d/likeshop.localhost.conf配置文件内容的域名，然后运行 docker exec -it likeshop-nginx nginx -s reload ，重启nginx容器。

#### 产品软件安装
安装
然后访问域名 http://www.likeshop.localhost， 按部署安装产品。


docker部署安装时，数据库地址填写容器名，账号密码默认为root，也可以在部署之前修改docker-compose.yml配置更改密码。


## 发布上线
### 准备工作
#### 编辑器下载
uni-app运行和编译需要使用HBuilderX编辑器打开，根据系统下载，请下载App开发版。
HBuilderX下载地址： https://www.dcloud.io/hbuilderx.html

#### 安装插件
打开链接:https://ext.dcloud.net.cn/plugin?id=2046
，注册账号后，安装”scss/sass编译插件”。

#### 打开项目
使用HBuilderX编辑器打开源码的uniapp目录。

#### 设置服务端地址
打开likeshop/uniapp/cofnig/app.js目录，修改一下的域名地址为服务端部署的域名地址（不要使用本地地址），修改完记得按ctrl+s或command+s保存！！注意！！！，小程序正式发布使用，需要配置https。

### 微信小程序
微信小程序配置
1.打开likeshop管理后台-微信-小程序设置。再打开并登录https://mp.weixin.qq.com/，点击开发管理。从微信小程序后台复制开发者ID(AppID)、开发者密码(AppSecret)到likeshop管理后台，开发者密码(AppSecret)首次需要生成，然后再likeshop管理后台点击确定，保存信息。



打开likeshop管理后台-微信-小程序设置，再打开微信小程序后台，点击开发管理，修改配置，从likeshop后台的服务器配置项复制URL到微信小程序后台对应的项，然后提交，保存信息。保存的时,要求验证服务器，按提示，将txt文件下载，放进服务器的server/public目录即可。


微信小程序发布
打开下载好的HBuilderX，选择【工具】-》【设置】-》【运行设置】，找到小程序运行配置，设置好微信开发工具路径。（如果是MAC系统可能是不需要配置的可以直接跳过这个步骤）



打开微信开发者工具，点击设置图标、找到安全项、开启服务端口。
域名还未添加https一定要开启这个不然运行会出错



找到工具栏，打开【发行】-》【小程序-微信】，填写小程序名称，设置小程序AppId，点击发行。注意：1.一定要打开【发行】，不要点击【运行】！！！2.这里一定要填写自己的小程序名称，不然发布的时候，可能有些页面，会显示likeshop。
PLUS多开版：config/app.js中的域名需指向平台新增商城时生成的三级域名。






点击发行编译完成以后，不需要手动开发开发者工具，开发者工具会自动打开，如果小程序运行不正常，设置调试基础版本为2.9.5，然后再编译几次直到自动开发开发者工具为止。
打开后如下图：



点击【上传】-【确定】，提交小程序体验版。



登录小程序后台，打开管理-版本管理，找到刚才提交的体验版，提交审核即可。审核通过以后，在列表里找到审核版本，提交发布即可。



最后一步；收到审核通过通知后点击提交发布



如出现要求填写隐私协助，可参考下面方式填写及结合自身实际情况填写



### 微信公众号②
如果需要使用微信公众号授权登录、支付等接口，需要按一下配置。

微信公众号配置
1.打开likeshop管理后台-微信-公众号设置。再打开https://mp.weixin.qq.com/，点击公众号设置。从微信公众号后台复制开发者ID(AppID)、开发者密码(AppSecret)到likeshop管理后台，开发者密码(AppSecret)首次需要生成，下面IP白名单填写服务器的ip地址。然后再likeshop管理后台点击确定，保存信息。

2.打开likeshop管理后台-微信-公众号设置，在服务器配置项上填写Token、EncodingAESKey，可以填写任意字符，然后确定保存信息。再打开https://mp.weixin.qq.com/，点击公众号设置，修改配置，从LikeShop后台的服务器配置项复制URL、Token、EncodingAESKey到微信公众号后台对应的项，然后提交，保存信息。




打开likeshop管理后台-微信-公众号设置。再打开微信公众号后台，点击公众号设置。将功能设置项的业务域名、JS接口安全域名、网页授权域名复制到微信后台并保存。保存的时,要求验证服务器，按提示，将txt文件下载，放进服务器的server/public目录即可。



上线
在微信打开域名即可访问。

### 安卓苹果APP③
1.修改app配置
用HBuilderX打开项目，点击manifest.json文件

设置app图标

点击浏览选择一个1024x1024的图片传上去，再点击自动生成图标并替换就可以了


设置app模块
默认勾选 支付、登录、分享、 ViderPlayer等模块，需要使用到其他模块请自行勾选。
其中的微信支付、微信登录、微信分享等模块需要特殊配置。



微信登录



微信分享



微信支付



权限设置
安卓的已经配置好了，ios的必须填写相关的描述信息，需要用那些权限就填写哪些，必须填写详细，不然上架容易被拒



修改请求域名
找到config/app.js文件，将下图中的域名修改为您的域名


2.开发调试
mac端
安装xCode，安装苹果模拟器
在HBuilderX，点击运行 ，选择运行到手机或模拟器，选择您想要的模拟器便可直接运行

需要调试第三方sdk(如微信登录，支付)的需要使用自定义基座才能调试，详见https://ask.dcloud.net.cn/article/35115

3.打包上线
安卓端**
点击发行>原生-app云打包

主要配置的地方是证书别名，证书私钥密码和证书文件
安卓生成签名及查看签名教程详见:（https://ask.dcloud.net.cn/article/35777）
配置好以后点击打包，打包成功后控制台有链接自行下载就可以了


苹果端
ios打包前微信所有的相关配置需要appid和需要生成ios平台通用链接



ios通用链接配置
https://ask.dcloud.net.cn/article/36393#unilink


ios通用链接生成
https://ask.dcloud.net.cn/article/36445


配置好通用链接后，点击发行>原生-app云打包



需要配置的地方是证书私钥密码，证书profile文件和私钥证书
生成苹果证书教程和p12文件教程详见https://www.jianshu.com/p/ae11b893284b

以上配置好后点击打包，打包成功后控制台有链接自行下载就可以了
生成好ipa文件后，在Transporter这个软件上传

### PC端（支持SEO模式）④
说明
安装完程序以后，默认自动PC端，一般情况下，不需要再部署。如果有SEO需求，我们就需要使用node服务器运行PC端。

部署
文件修改
1.打开likeshop/server/pc/nuxt.config.js，将ssr的值改成true，找到 base: ‘/pc/‘，注释掉。



2.打开likeshop/pc/config/app.js，将productUrl的值改成域名。



编译
1.cd命令进入likeshop/server/pc，运行 npm install安装依赖，运行npm run build编译。


2.编译成功好，会生成以下文件,将pc端目录提交到服务器，注意，其中.nuxt是隐藏文件，不要遗漏。


服务器部署
1.部署之前，如果服务器没有安装node，需要打开宝塔【软件商店】，搜索“node”，安装【Node.js版本管理器 1.6】。


2.将pc端文件夹打开，传到服务器。打开【网站】-【node项目】-【添加node项目】，设置好pc端文件夹上传到的位置、域名等参数,然后添加即可。



3.如果第二步安装依赖时间超过15分钟，直接刷新页面，进入node项目设置，【服务状态】，手动启动项目。

4.启动后打开设置的域名，即可使用SEO模式访问PC端。

## 配置
### 定时任务设置
#### 宝塔
宝塔定时任务配置①
打开【计划任务】，添加计划任务，设置定时任务脚本，

php /www/wwwroot/www.likeshop.cn/server/think crontab
其中，/www/wwwroot/www.likeshop.cn/server/think为项目的think文件绝对路径，根据自己的项目设定。


问题
如果是因为php版本报错，切在将命令行切换为相应的php版本。
#### linux定时任务配置②
在linux终端配置执行crontab -e，设置脚本内容如下：
*/1 * * * * php /www/wwwroot/www.likeshop.cn/server/think crontab ,保存内容，www/wwwroot/likeshop.*.cn/server为项目服务端所在绝对的路径。
